<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Escape Room Control + Display</title>
<script src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  body, html { margin: 0; height: 100%; width: 100%; background: black; }
  #root { height: 100%; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const { useState, useEffect } = React;

// ----- Routing -----
function useHashRoute() {
  const [hash, setHash] = useState(window.location.hash);
  useEffect(() => {
    const onHash = () => setHash(window.location.hash);
    window.addEventListener("hashchange", onHash);
    return () => window.removeEventListener("hashchange", onHash);
  }, []);
  return hash.replace(/^#\/?/, "/");
}

// ----- Persistent State -----
function usePersistentState(key, initial) {
  const [value, setValue] = useState(() => {
    const saved = localStorage.getItem(key);
    return saved ? JSON.parse(saved) : initial;
  });
  useEffect(() => {
    localStorage.setItem(key, JSON.stringify(value));
  }, [key, value]);
  return [value, setValue];
}

// ----- App -----
function App() {
  const route = useHashRoute();
  const [state, setState] = usePersistentState("escapeRoomState", {
    time: 60 * 60,
    running: false,
    clues: [], // { url, timestamp }
    subtitle: "",
    blackout: false,
    lastMessage: null
  });

  return route === "/display" ? (
    <Display state={state} />
  ) : (
    <Control state={state} setState={setState} />
  );
}

// ----- Format time -----
function formatTime(sec) {
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${m}:${s.toString().padStart(2,"0")}`;
}

// ----- Control Page -----
function Control({ state, setState }) {
  const [recording, setRecording] = useState(false);
  const [recorder, setRecorder] = useState(null);
  const [chunks, setChunks] = useState([]);
  const [subtitleInput, setSubtitleInput] = useState(state.subtitle || "");

  // Timer
  useEffect(() => {
    if (!state.running) return;
    const id = setInterval(() => {
      setState(s => ({
        ...s,
        time: s.time>0 ? s.time-1 : 0,
        running: s.time>0
      }));
    }, 1000);
    return () => clearInterval(id);
  }, [state.running]);

  const start = () => setState(s=>({...s, running:true, time: 3600}));
  const pause = () => setState(s=>({...s, running:false}));
  const resume = () => setState(s=>({...s, running:true}));
  const reset = () => setState(s=>({...s, time:3600, running:false}));

  const openDisplay = () => window.open("#/display", "_blank");

  // Clue recording
  const startRecording = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const mediaRecorder = new MediaRecorder(stream);
    setRecorder(mediaRecorder);
    setChunks([]);
    mediaRecorder.ondataavailable = e => {
      if(e.data.size>0) setChunks(prev=>[...prev,e.data]);
    };
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks,{type:"audio/webm"});
      const url = URL.createObjectURL(blob);
      setState(s=>({...s, clues:[...s.clues,{url,timestamp:new Date().toLocaleTimeString()}]}));
      const audio = new Audio(url); audio.play();
    };
    mediaRecorder.start();
    setRecording(true);
  };
  const stopRecording = () => { if(recorder){recorder.stop(); setRecording(false);}};

  const setSubtitle = () => {
    setState(s=>({...s, subtitle: subtitleInput}));
  };

  const toggleBlackout = () => {
    setState(s=>({...s, blackout: !s.blackout}));
  };

  return (
    <div className="p-6 text-white">
      <h1 className="text-2xl font-bold mb-4">Escape Room Control</h1>

      <div className="mb-4">Time: {formatTime(state.time)}</div>
      <div className="flex gap-2 mb-6">
        {!state.running ? 
          <button onClick={start} className="px-3 py-1 bg-green-600 rounded">Start</button> :
          <button onClick={pause} className="px-3 py-1 bg-yellow-600 rounded">Pause</button>
        }
        <button onClick={resume} className="px-3 py-1 bg-blue-600 rounded">Resume</button>
        <button onClick={reset} className="px-3 py-1 bg-red-600 rounded">Reset</button>
      </div>

      <div className="mb-4">
        <button onClick={openDisplay} className="px-3 py-1 bg-purple-600 rounded">Open Display Page</button>
      </div>

      <div className="mb-6">
        {!recording ?
          <button onClick={startRecording} className="px-3 py-1 bg-blue-600 rounded">üéôÔ∏è Record Clue</button> :
          <button onClick={stopRecording} className="px-3 py-1 bg-red-600 rounded">‚èπ Stop Recording</button>
        }
      </div>

      <div className="mb-6">
        <input type="text" value={subtitleInput} onChange={e=>setSubtitleInput(e.target.value)} className="text-black p-1 rounded mr-2"/>
        <button onClick={setSubtitle} className="px-3 py-1 bg-green-700 rounded">Set Subtitle</button>
      </div>

      <div className="mb-6">
        <button onClick={toggleBlackout} className="px-3 py-1 bg-gray-800 rounded">{state.blackout ? "Show Screen" : "Blackout"}</button>
      </div>

      <div>
        <h2 className="text-xl font-bold mb-2">Recorded Clues</h2>
        <ul className="space-y-2">
          {state.clues.map((c,i)=>(
            <li key={i} className="flex gap-2 items-center">
              <span>{c.timestamp}</span>
              <button onClick={()=>new Audio(c.url).play()} className="px-2 py-1 bg-blue-500 rounded">‚ñ∂Ô∏è Play</button>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
}

// ----- Display Page -----
function Display({ state }) {
  useEffect(()=>{
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen().catch(()=>{});
    }
  }, []);

  useEffect(()=>{
    if(state.clues.length>0){
      const last = state.clues[state.clues.length-1];
      const audio = new Audio(last.url);
      audio.play();
    }
  }, [state.clues]);

  return (
    <div className={`w-full h-full flex flex-col items-center justify-center ${state.blackout?"bg-black":"bg-gray-900"} text-white`}>
      <div className="text-8xl">{formatTime(state.time)}</div>
      {state.subtitle && <div className="text-3xl mt-4">{state.subtitle}</div>}
      {state.clues.length>0 &&
        <audio controls src={state.clues[state.clues.length-1].url} className="mt-4"/>
      }
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById("root"));

</script>
</body>
</html>
