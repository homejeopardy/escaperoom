<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escape Room Controller</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel (so JSX works in the browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; }
    body { font-family: sans-serif; }
  </style>
</head>
<body class="bg-black text-white">
  <div id="root"></div>

  <script type="text/babel">
    /*************************************************************
     * Escape Room Control + Display
     * (All-in-one React app for GitHub Pages, hash routing)
     *************************************************************/

    const { useState, useEffect, useMemo, useRef } = React;

    // --- Utilities ---
    const chName = "escape-room-control";
    const bc = typeof window !== "undefined" && "BroadcastChannel" in window
      ? new BroadcastChannel(chName)
      : null;

    const nowMs = () => Date.now();
    const pad2 = (n) => n.toString().padStart(2, "0");

    function msToClock(ms) {
      const total = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(total / 3600);
      const m = Math.floor((total % 3600) / 60);
      const s = total % 60;
      return h > 0 ? `${h}:${pad2(m)}:${pad2(s)}` : `${m}:${pad2(s)}`;
    }

    function useHashRoute() {
      const [hash, setHash] = useState(() => window.location.hash || "#/control");
      useEffect(() => {
        const onHash = () => setHash(window.location.hash || "#/control");
        window.addEventListener("hashchange", onHash);
        return () => window.removeEventListener("hashchange", onHash);
      }, []);
      return hash.replace(/^#\\/?/, "/");
    }

    function usePersistentState(key, initial) {
      const [state, setState] = useState(() => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : initial;
        } catch {
          return initial;
        }
      });
      useEffect(() => {
        try { localStorage.setItem(key, JSON.stringify(state)); } catch {}
      }, [key, state]);
      return [state, setState];
    }

    function send(type, payload) {
      if (!bc) return;
      bc.postMessage({ type, payload, at: Date.now() });
    }

    // --- Themes ---
    const THEMES = {
      dark: {
        name: "Dark",
        bg: "bg-black",
        text: "text-white",
        accent: "text-slate-300",
      },
      neon: {
        name: "Neon",
        bg: "bg-zinc-900",
        text: "text-lime-400",
        accent: "text-emerald-300",
      },
      royal: {
        name: "Royal",
        bg: "bg-indigo-950",
        text: "text-indigo-100",
        accent: "text-fuchsia-200",
      },
    };

    // --- Display ---
    function Display({ settings }) {
      const theme = THEMES[settings.theme] || THEMES.dark;
      const [clock, setClock] = useState(settings.durationMs || 3600000);
      const [running, setRunning] = useState(false);
      const [msg, setMsg] = useState("");
      const [subtitle, setSubtitle] = useState(settings.subtitle || "");
      const [blackout, setBlackout] = useState(false);
      const [overlayUrl, setOverlayUrl] = useState(settings.overlayUrl || "");
      const [roomName, setRoomName] = useState(settings.roomName || "Escape Room");
      const lastTick = useRef(null);

      useEffect(() => {
        if (!bc) return;
        const onMsg = async (e) => {
          const { type, payload } = e.data || {};
          if (type === "display:goFullscreen") {
            try { await document.documentElement.requestFullscreen(); } catch {}
          }
        };
        bc.addEventListener("message", onMsg);
        return () => bc.removeEventListener("message", onMsg);
      }, []);

      useEffect(() => {
        if (!bc) return;
        const onMsg = (e) => {
          const { type, payload } = e.data || {};
          switch (type) {
            case "timer:set": setClock(payload.ms); break;
            case "timer:start": setRunning(true); lastTick.current = nowMs(); break;
            case "timer:pause": setRunning(false); break;
            case "timer:reset": setClock(payload.ms); setRunning(false); break;
            case "display:message": setMsg(payload); break;
            case "display:subtitle": setSubtitle(payload); break;
            case "display:blackout": setBlackout(payload); break;
            case "display:overlay": setOverlayUrl(payload); break;
            case "display:room": setRoomName(payload); break;
            default: break;
          }
        };
        bc.addEventListener("message", onMsg);
        return () => bc.removeEventListener("message", onMsg);
      }, []);

      useEffect(() => {
        if (!running) return;
        const id = requestAnimationFrame(function tick() {
          const now = nowMs();
          const last = lastTick.current ?? now;
          const delta = now - last;
          lastTick.current = now;
          setClock((ms) => Math.max(0, ms - delta));
          requestAnimationFrame(tick);
        });
        return () => cancelAnimationFrame(id);
      }, [running]);

      const clockText = useMemo(() => msToClock(clock), [clock]);

      return (
        <div className={`${theme.bg} ${theme.text} min-h-screen w-full relative`}>
          {overlayUrl && !blackout && (
            <div className="absolute inset-0 opacity-20 bg-center bg-cover"
                 style={{ backgroundImage: `url(${overlayUrl})` }} />
          )}
          <div className="relative z-10 flex flex-col items-center justify-center min-h-screen p-8 text-center">
            <div className="text-sm opacity-70 tracking-widest uppercase">{roomName}</div>
            <div className="text-[18vw] leading-none font-bold tabular-nums">{clockText}</div>
            {subtitle && <div className={`mt-2 text-xl md:text-2xl ${theme.accent}`}>{subtitle}</div>}
            {msg && (
              <div className="mt-6 max-w-4xl text-2xl md:text-4xl font-semibold">{msg}</div>
            )}
          </div>
          {blackout && <div className="absolute inset-0 bg-black" />}
        </div>
      );
    }

    // --- Control ---
    function Control({ settings, setSettings }) {
      const [durationMin, setDurationMin] = useState(Math.floor((settings.durationMs || 3600000) / 60000));
      const [customMsg, setCustomMsg] = useState("");

      const applyDuration = (min) => {
        const ms = Math.max(0, Math.floor(min) * 60000);
        send("timer:set", { ms });
      };
      const start = () => send("timer:start");
      const pause = () => send("timer:pause");
      const reset = () => send("timer:reset", { ms: durationMin * 60000 });
      const pushMsg = () => { send("display:message", customMsg.trim()); setCustomMsg(""); };
      const openDisplay = () => {
        const w = window.open(`${location.origin}${location.pathname}#/display`, "display");
        setTimeout(() => send("display:goFullscreen"), 300);
      };
      const setBlackout = (v) => send("display:blackout", v);

      return (
        <div className="min-h-screen bg-slate-900 text-slate-100 p-6">
          <div className="max-w-4xl mx-auto">
            <h1 className="text-2xl font-bold mb-4">Escape Room – Control</h1>
            <button onClick={openDisplay} className="px-4 py-2 rounded bg-blue-500">Open Display</button>
            <div className="mt-6">
              <label className="block mb-2">Duration (minutes)
                <input type="number" className="text-black ml-2 p-1"
                  value={durationMin}
                  onChange={(e)=> setDurationMin(Number(e.target.value))}
                  onBlur={()=> applyDuration(durationMin)} />
              </label>
              <button onClick={start} className="mr-2 px-3 py-1 bg-emerald-500">Start</button>
              <button onClick={pause} className="mr-2 px-3 py-1 bg-amber-500">Pause</button>
              <button onClick={reset} className="px-3 py-1 bg-gray-600">Reset</button>
            </div>
            <div className="mt-6">
              <input className="text-black p-1 mr-2"
                placeholder="Message…" value={customMsg}
                onChange={(e)=> setCustomMsg(e.target.value)} />
              <button onClick={pushMsg} className="px-3 py-1 bg-blue-500">Send</button>
              <button onClick={()=> send("display:message", "")} className="px-3 py-1 bg-gray-600 ml-2">Clear</button>
            </div>
            <div className="mt-6">
              <button onClick={()=> setBlackout(true)} className="px-3 py-1 bg-black">Blackout</button>
              <button onClick={()=> setBlackout(false)} className="px-3 py-1 bg-gray-600 ml-2">Show</button>
            </div>
          </div>
        </div>
      );
    }

    // --- App ---
    function App() {
      const route = useHashRoute();
      const [settings, setSettings] = usePersistentState("escapeSettings", {
        theme: "dark",
        durationMs: 3600000,
        roomName: "Escape Room",
        subtitle: "",
        overlayUrl: "",
      });
      return (
        <div>
          {route === "/display"
            ? <Display settings={settings} />
            : <Control settings={settings} setSettings={setSettings} />}
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
