<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escape Room Control + Display</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel (so JSX works in the browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; }
    body { font-family: sans-serif; }
  </style>
</head>
<body class="bg-black text-white">
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useEffect } = React;

    // Simple hook for hash-based routing
    function useHashRoute() {
      const [hash, setHash] = useState(window.location.hash || "#/control");
      useEffect(() => {
        const onHash = () => setHash(window.location.hash || "#/control");
        window.addEventListener("hashchange", onHash);
        return () => window.removeEventListener("hashchange", onHash);
      }, []);
      return hash.replace(/^#\/?/, "/"); // âœ… fixed regex
    }

    function usePersistentState(key, initial) {
      const [val, setVal] = useState(() => {
        try {
          const stored = localStorage.getItem(key);
          return stored ? JSON.parse(stored) : initial;
        } catch {
          return initial;
        }
      });
      useEffect(() => {
        localStorage.setItem(key, JSON.stringify(val));
      }, [key, val]);
      return [val, setVal];
    }

    // Shared channel
    const channel = new BroadcastChannel("escape-room");

    function Control() {
      const [duration, setDuration] = usePersistentState("duration", 60);
      const [running, setRunning] = useState(false);
      const [remaining, setRemaining] = useState(duration * 60);
      const [message, setMessage] = useState("");
      const [subtitle, setSubtitle] = usePersistentState("subtitle", "");

      useEffect(() => {
        let timer;
        if (running && remaining > 0) {
          timer = setInterval(() => setRemaining(r => r - 1), 1000);
        }
        return () => clearInterval(timer);
      }, [running, remaining]);

      useEffect(() => {
        channel.postMessage({ type: "update", remaining, running, subtitle });
      }, [remaining, running, subtitle]);

      function start() {
        setRemaining(duration * 60);
        setRunning(true);
      }
      function pause() { setRunning(false); }
      function reset() { setRemaining(duration * 60); setRunning(false); }

      function sendMessage() {
        channel.postMessage({ type: "message", text: message });
        setMessage("");
      }

      function blackout() {
        channel.postMessage({ type: "blackout" });
      }

      function openDisplay() {
        const w = window.open("#/display", "_blank");
        if (w) {
          w.focus();
        }
      }

      return (
        <div className="p-6 space-y-4">
          <h1 className="text-2xl font-bold">Escape Room Control</h1>
          <div className="space-x-2">
            <label>Duration (minutes):</label>
            <input
              type="number"
              value={duration}
              onChange={e => setDuration(parseInt(e.target.value))}
              className="text-black p-1 rounded"
            />
          </div>
          <div className="space-x-2">
            <button onClick={start} className="bg-green-600 px-3 py-1 rounded">Start</button>
            <button onClick={pause} className="bg-yellow-600 px-3 py-1 rounded">Pause</button>
            <button onClick={reset} className="bg-red-600 px-3 py-1 rounded">Reset</button>
          </div>
          <div>
            <label>Subtitle: </label>
            <input
              type="text"
              value={subtitle}
              onChange={e => setSubtitle(e.target.value)}
              className="text-black p-1 rounded"
            />
          </div>
          <div className="space-x-2">
            <input
              type="text"
              value={message}
              onChange={e => setMessage(e.target.value)}
              placeholder="Clue or announcement"
              className="text-black p-1 rounded"
            />
            <button onClick={sendMessage} className="bg-blue-600 px-3 py-1 rounded">Send</button>
          </div>
          <button onClick={blackout} className="bg-gray-800 px-3 py-1 rounded">Blackout</button>
          <div>
            <button onClick={openDisplay} className="bg-purple-600 px-3 py-1 rounded">
              Open Display Window
            </button>
          </div>
        </div>
      );
    }

    function Display() {
      const [remaining, setRemaining] = useState(0);
      const [running, setRunning] = useState(false);
      const [subtitle, setSubtitle] = useState("");
      const [message, setMessage] = useState("");
      const [blackout, setBlackout] = useState(false);

      useEffect(() => {
        channel.onmessage = (e) => {
          const { type, ...data } = e.data;
          if (type === "update") {
            setRemaining(data.remaining);
            setRunning(data.running);
            setSubtitle(data.subtitle);
          } else if (type === "message") {
            setMessage(data.text);
            setTimeout(() => setMessage(""), 10000);
          } else if (type === "blackout") {
            setBlackout(b => !b);
          }
        };
      }, []);

      useEffect(() => {
        if (document.fullscreenElement == null) {
          document.documentElement.requestFullscreen().catch(() => {});
        }
      }, []);

      const mins = Math.floor(remaining / 60);
      const secs = remaining % 60;
      const timeStr = `${mins}:${secs.toString().padStart(2, "0")}`;

      return (
        <div className={`w-screen h-screen flex flex-col items-center justify-center ${blackout ? "bg-black" : "bg-gray-900"} text-white`}>
          <div className="text-8xl font-bold">{timeStr}</div>
          {subtitle && <div className="text-2xl mt-2">{subtitle}</div>}
          {message && <div className="text-3xl mt-6 bg-yellow-600 text-black px-4 py-2 rounded">{message}</div>}
        </div>
      );
    }

    function App() {
      const route = useHashRoute();
      if (route === "/display") return <Display />;
      return <Control />;
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);

  </script>
</body>
</html>
